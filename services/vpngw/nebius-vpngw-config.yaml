# nebius-vpngw-config.yaml
# Master configuration for Nebius VM-based VPN Gateway.

version: 1  # Config schema version for future migrations.

###############################################################################
# Gateway group: how many VMs, where, and their external IPs
###############################################################################
gateway_group:
  # A logical name for this group of VPN gateway instances.
  name: "nebius-vpn-gw"

  # Number of VM instances to create/manage.
  # - 1: single VM, typically with multiple tunnels (e.g., GCP HA, active/active tunnels).
  # - >1: gateway HA via multiple VMs; routing table points to one at a time.
  instance_count: 1

  # Nebius region / zone for the gateway VMs.
  region: "eu-north1-a"

  # VM hardware and OS specification.
  vm_spec:
    # Nebius platform / machine type (see Compute docs).
    platform: "standard-v2"
    cores: 2
    memory_gb: 4
    disk_gb: 50

    # Base image. You can use an image_family or explicit image_id.
    image_family: "ubuntu-22-04-lts"
    # image_id: "..."  # if you want a custom image.

    # SSH access / metadata as needed.
    ssh_public_key: "ssh-ed25519 AAAA... user@host"

    # Subnet IDs for network interfaces.
    # Typically all gateway VMs go into a dedicated VPN subnet.
    vpn_subnet_id: "vpcsubnet-xxx"

  # Public IPv4 addresses to be associated with gateway interfaces.
  # Semantics:
  # - external_ips[0] → first NIC's public IP on each VM or VM0 (depending on deployment).
  # - external_ips[1] → second NIC's public IP, etc.
  # The provisioning layer maps each entry to a NIC's PublicIPAddress spec.
  external_ips:
    - "203.0.113.10"
    # - "203.0.113.11"  # Uncomment if you need a second public IP.

###############################################################################
# Gateway-wide parameters (BGP ASN, local prefixes, quotas)
###############################################################################
gateway:
  # Local BGP ASN used by this gateway group.
  # May be overridden at connection/tunnel level if necessary.
  local_asn: 65010

  # Local CIDR blocks (in Nebius VPC) that can be advertised to peers.
  # Used as default export set for BGP and static routing sanity checks.
  local_prefixes:
    - 10.0.0.0/16

  quotas:
    # Maximum number of logical connections (groups of tunnels) on this gateway.
    max_connections: 16

    # Maximum number of tunnels across all connections.
    max_tunnels: 32

    # Optional total bandwidth cap (Mbps) for all tunnels combined.
    # Implementation may use traffic shaping on the VM; leave null to disable.
    max_total_bandwidth_mbps: null

###############################################################################
# Global defaults for VPN behavior, crypto, DPD, and routing
###############################################################################
defaults:
  # Global VPN type. Only "ipsec" is supported in v1.
  vpn_type: ipsec

  # Default IKE version. Tunnels may override.
  ike_version: 2

  # Allow legacy IKEv1 if a tunnel explicitly requests ike_version: 1.
  allow_ikev1: true

  auth:
    # Authentication method. v1 supports only PSK.
    method: psk

  crypto:
    # Default IKE (phase 1) proposals.
    # Format: encryption-integrity-dhgroup
    ike_proposals:
      - "aes256-sha256-modp2048"
      - "aes256-sha384-ecp384"
      - "aes256-sha512-modp2048_256"

    # Default IKE SA lifetime in seconds.
    # Peer configs may override this unless a tunnel explicitly sets it.
    ike_lifetime_seconds: 28800  # 8 hours

    # Default ESP (phase 2) proposals for data SAs.
    esp_proposals:
      - "aes256-sha256"
      - "aes256-sha384"
      - "aes256-sha512"

    # Default ESP SA lifetime in seconds.
    esp_lifetime_seconds: 3600   # 1 hour

    # Allowed DH groups; peer configs must be compatible with these.
    dh_groups:
      - 14
      - 20
      - 24

  dpd:
    # Dead Peer Detection interval in seconds.
    interval_seconds: 30

    # Time without responses before peer is considered dead.
    timeout_seconds: 120

  routing:
    # Global default routing mode: "bgp" or "static".
    mode: bgp

    bgp:
      # Default BGP hold time and keepalive (seconds).
      hold_time_seconds: 90
      keepalive_seconds: 30

      # Enable BGP graceful restart by default.
      graceful_restart: true

      # Default maximum number of prefixes accepted from a peer.
      max_prefixes: 1000

###############################################################################
# Connections: each logical relationship to a single remote VPN gateway
###############################################################################
connections:
  ###########################################################################
  # Example 1: GCP HA VPN using BGP
  ###########################################################################
  - name: "gcp-ha-vpn"
    # Free-form description.
    description: "Primary HA VPN to GCP"

    # Vendor hint; used to select the correct parser for --peer-config-file.
    vendor: "gcp"   # "gcp" | "aws" | "azure" | "cisco" | "generic"

    # Connection-level routing mode. If omitted, defaults.routing.mode is used.
    # For GCP HA VPN we typically use BGP.
    routing_mode: bgp

    # BGP settings for this connection.
    bgp:
      enabled: true

      # Remote ASN (GCP Cloud Router ASN). If a peer-config file has this value,
      # that will override this field unless explicitly set here.
      remote_asn: 64514

      # If true, advertise gateway.local_prefixes by default.
      advertise_local_prefixes: true

    # Connection-level crypto overrides (optional).
    crypto:
      # If true, ignore peer-config's crypto proposals and use defaults.crypto.
      # If false, prefer peer-config crypto when present.
      use_defaults_crypto: false

    # Tunnels for this connection. For GCP HA VPN, typically 2.
    tunnels:
      - name: "gcp-ha-tunnel-1"

        # Index of the gateway instance that owns this tunnel (0-based).
        # For instance_count = 1, always 0. For instance_count = 2, can be 0 or 1.
        gateway_instance_index: 0

        # Index into gateway_group.external_ips. Defines which public IP is used
        # as the local endpoint for this tunnel.
        local_public_ip_index: 0  # external_ips[0] = 203.0.113.10

        # HA role for this tunnel.
        # - "active": tunnel is configured and brought up.
        # - "disable": tunnel is configured in YAML but not created/used.
        ha_role: "active"

        # IKE version override for this tunnel. If null, use connection or global default.
        ike_version: null

        # Pre-shared key for this tunnel. If null, peer-config file must provide it.
        # In production, store securely (e.g., in KMS/secret manager).
        psk: null

        # Inner /30 network for this tunnel (for BGP or static routing).
        # If null, values are taken from peer-config if available.
        inner_cidr: null         # e.g., "169.254.10.0/30"
        inner_local_ip: null     # e.g., "169.254.10.1"
        inner_remote_ip: null    # e.g., "169.254.10.2"

        # Crypto overrides for this tunnel. If empty/null, use connection defaults,
        # then peer-config, then global defaults.
        crypto:
          ike_proposals: []           # e.g., ["aes256-sha256-modp2048"]
          esp_proposals: []           # e.g., ["aes256-sha256"]
          ike_lifetime_seconds: null  # override or null for default/peer-config
          esp_lifetime_seconds: null

        # Per-tunnel routing mode override. If null, connection.routing_mode is used.
        routing_mode: null            # "bgp" | "static" | null

        # Static routes for this tunnel, used only if routing_mode == "static".
        static_routes:
          remote_prefixes: []         # e.g., ["10.100.0.0/16"]
          local_prefixes: []          # override gateway.local_prefixes if needed

        # BGP per-tunnel overrides.
        bgp:
          local_ip: null              # e.g., 169.254.10.1
          remote_ip: null             # e.g., 169.254.10.2
          local_asn: null             # override gateway.local_asn
          remote_asn: null            # override connection.bgp.remote_asn
          advertise_local_prefixes: null

      - name: "gcp-ha-tunnel-2"
        gateway_instance_index: 0
        local_public_ip_index: 0
        ha_role: "active"
        ike_version: null
        psk: null
        inner_cidr: null
        inner_local_ip: null
        inner_remote_ip: null
        crypto:
          ike_proposals: []
          esp_proposals: []
          ike_lifetime_seconds: null
          esp_lifetime_seconds: null
        routing_mode: null
        static_routes:
          remote_prefixes: []
          local_prefixes: []
        bgp:
          local_ip: null
          remote_ip: null
          local_asn: null
          remote_asn: null
          advertise_local_prefixes: null

  ###########################################################################
  # Example 2: On-prem Cisco router using static routing
  ###########################################################################
  - name: "onprem-static"
    description: "On-prem DC using static routing"
    vendor: "cisco"

    # Use static routing for this connection.
    routing_mode: static

    bgp:
      enabled: false
      remote_asn: null
      advertise_local_prefixes: false

    tunnels:
      - name: "onprem-static-tunnel-1"
        gateway_instance_index: 0
        local_public_ip_index: 0
        ha_role: "active"
        ike_version: 1         # Legacy IKEv1 if needed
        psk: "SuperSecretPsk123!"
        inner_cidr: "169.254.20.0/30"
        inner_local_ip: "169.254.20.1"
        inner_remote_ip: "169.254.20.2"
        crypto:
          ike_proposals:
            - "aes256-sha256-modp2048"
          esp_proposals:
            - "aes256-sha256"
          ike_lifetime_seconds: 28800
          esp_lifetime_seconds: 3600
        routing_mode: static
        static_routes:
          remote_prefixes:
            - "172.16.0.0/12"
            - "192.168.0.0/16"
          local_prefixes:
            - "10.0.0.0/16"
        bgp:
          local_ip: null
          remote_ip: null
          local_asn: null
          remote_asn: null
          advertise_local_prefixes: false
