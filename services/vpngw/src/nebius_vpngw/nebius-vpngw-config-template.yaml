# nebius-vpngw-config-template.yaml
# Template configuration for Nebius VM-based VPN Gateway.
# Fill placeholders with environment-specific values. Do NOT commit secrets.

version: 1

###############################################################################
# Nebius tenant/project/region context (top-level)
# Prefer exporting these as environment variables and referencing via ${...}
tenant_id: "${TENANT_ID}"
project_id: "${PROJECT_ID}"
region_id: "${REGION_ID}" # e.g., us-central1 | eu-north1 | eu-north2 | eu-west1

###############################################################################
# Gateway group: how many VMs, where, and their external IPs
###############################################################################

gateway_group:
  name: "nebius-vpn-gw"
  instance_count: 1
  # VM specification.
  vm_spec:
    platform: "cpu-d3" # e.g., cpu-e2 | cpu-d3 ; see Nebius docs for options: https://docs.nebius.com/compute/virtual-machines/types
    preset: "32vcpu-128gb" # see Nebius docs for preset options: https://docs.nebius.com/compute/virtual-machines/types
    disk_boot_image: ubuntu24.04-driverless
    disk_gb: 200
    disk_type: network_ssd
    disk_block_bytes: 4096
    # SSH access / metadata as needed.
    # You can provide the public key content directly OR point to a local file path.
    # Option A (inline content):
    # ssh_public_key: "${SSH_PUBLIC_KEY}" # e.g., ssh-ed25519 AAAA... user@host
    # Option B (path to your ~/.ssh public key). If provided and ssh_public_key is empty,
    # the orchestrator will read this file and inline its contents automatically.
    # Explicit key paths (recommended): only paths, never key contents.
    ssh_public_key_path: "~/.ssh/id_ed25519.pub" # public key injected to VM
    ssh_private_key_path: "~/.ssh/id_ed25519" # private key used locally for SSH
    # Optional SSH username used by the orchestrator (Paramiko).
    # If ssh_private_key_path is omitted, the orchestrator falls back to your SSH agent
    # and default key discovery (e.g., ~/.ssh/id_ed25519, id_rsa).
    # ssh_username: "ubuntu"


    # Network/subnet configuration for the VM NICs.
    # Optional: VPC network to create/locate the gateway subnet in.
    # If omitted or left as an unresolved placeholder, the orchestrator will use the network named "default-network".
    # Comment out this line entirely if you want to use the default network.
    # network_id: "${NETWORK_ID}"  # optional; falls back to default-network
    # The orchestrator ensures a single gateway subnet named "vpngw-subnet" (/27)
    # inside the chosen network (network_id or default-network), and attaches
    # two NICs (eth0, eth1) for each VM to that subnet.

    # Public IPv4 addresses to be associated with gateway interfaces (existing allocations).
    # Optional: provide two entries (one per NIC). If omitted or placeholders remain unresolved,
    # the orchestrator will create two allocations under "vpngw-subnet" and attach them to eth0/eth1.
    # external_ips:
    # - "${GW_PUBLIC_IP_0}"  # optional: existing allocation IP for eth0
    # - "${GW_PUBLIC_IP_1}"  # optional: existing allocation IP for eth1

    ###############################################################################
    # Gateway-wide parameters (BGP ASN, local prefixes, quotas)
    ###############################################################################
gateway:
  local_asn: 65010
  local_prefixes:
  - 10.0.0.0/16
  quotas:
    max_connections: 16
    max_tunnels: 32
    max_total_bandwidth_mbps: null

###############################################################################
# Global defaults for VPN behavior, crypto, DPD, and routing
###############################################################################
defaults:
  vpn_type: ipsec
  ike_version: 2
  allow_ikev1: true

  auth:
    method: psk

  crypto:
    ike_proposals:
    - "aes256-sha256-modp2048"
    - "aes256-sha384-ecp384"
    - "aes256-sha512-modp2048_256"
    ike_lifetime_seconds: 28800
    esp_proposals:
    - "aes256-sha256"
    - "aes256-sha384"
    - "aes256-sha512"
    esp_lifetime_seconds: 3600
    dh_groups:
    - 14
    - 20
    - 24

  dpd:
    interval_seconds: 30
    timeout_seconds: 120

  routing:
    mode: bgp
    bgp:
      hold_time_seconds: 90
      keepalive_seconds: 30
      graceful_restart: true
      max_prefixes: 1000

###############################################################################
# Connections: each logical relationship to a single remote VPN gateway
###############################################################################
connections:
###########################################################################
# Example 1: GCP HA VPN using BGP
###########################################################################
- name: "gcp-ha-vpn"
  description: "Primary HA VPN to GCP"
  vendor: "gcp"
  routing_mode: bgp

  bgp:
    enabled: true
    remote_asn: ${GCP_REMOTE_ASN} # e.g., 64514
    advertise_local_prefixes: true

  crypto:
    use_defaults_crypto: false

  tunnels:
  - name: "gcp-ha-tunnel-1"
    gateway_instance_index: 0
    local_public_ip_index: 0
    ha_role: "active"
    ike_version: null
    psk: ${GCP_TUNNEL_1_PSK} # REQUIRED secret via env/secret store
    inner_cidr: ${GCP_TUNNEL_1_INNER_CIDR} # e.g., "169.254.10.0/30"
    inner_local_ip: ${GCP_TUNNEL_1_LOCAL_IP} # e.g., "169.254.10.1"
    inner_remote_ip: ${GCP_TUNNEL_1_REMOTE_IP} # e.g., "169.254.10.2"
    crypto:
      ike_proposals: []
      esp_proposals: []
      ike_lifetime_seconds: null
      esp_lifetime_seconds: null
    routing_mode: null
    static_routes:
      remote_prefixes: []
      local_prefixes: []
    bgp:
      local_ip: null
      remote_ip: null
      local_asn: null
      remote_asn: null
      advertise_local_prefixes: null

  - name: "gcp-ha-tunnel-2"
    gateway_instance_index: 0
    local_public_ip_index: 0
    ha_role: "active"
    ike_version: null
    psk: ${GCP_TUNNEL_2_PSK} # REQUIRED secret via env/secret store
    inner_cidr: ${GCP_TUNNEL_2_INNER_CIDR}
    inner_local_ip: ${GCP_TUNNEL_2_LOCAL_IP}
    inner_remote_ip: ${GCP_TUNNEL_2_REMOTE_IP}
    crypto:
      ike_proposals: []
      esp_proposals: []
      ike_lifetime_seconds: null
      esp_lifetime_seconds: null
    routing_mode: null
    static_routes:
      remote_prefixes: []
      local_prefixes: []
    bgp:
      local_ip: null
      remote_ip: null
      local_asn: null
      remote_asn: null
      advertise_local_prefixes: null

###########################################################################
# Example 2: On-prem Cisco router using static routing
###########################################################################
- name: "onprem-static"
  description: "On-prem DC using static routing"
  vendor: "cisco"
  routing_mode: static

  bgp:
    enabled: false
    remote_asn: null
    advertise_local_prefixes: false

  tunnels:
  - name: "onprem-static-tunnel-1"
    gateway_instance_index: 0
    local_public_ip_index: 0
    ha_role: "active"
    ike_version: 1
    psk: ${ONPREM_TUNNEL_1_PSK} # REQUIRED secret via env/secret store
    inner_cidr: ${ONPREM_TUNNEL_1_INNER_CIDR}
    inner_local_ip: ${ONPREM_TUNNEL_1_LOCAL_IP}
    inner_remote_ip: ${ONPREM_TUNNEL_1_REMOTE_IP}
    crypto:
      ike_proposals:
      - "aes256-sha256-modp2048"
      esp_proposals:
      - "aes256-sha256"
      ike_lifetime_seconds: 28800
      esp_lifetime_seconds: 3600
    routing_mode: static
    static_routes:
      remote_prefixes:
      - "172.16.0.0/12"
      - "192.168.0.0/16"
      local_prefixes:
      - "10.0.0.0/16"
    bgp:
      local_ip: null
      remote_ip: null
      local_asn: null
      remote_asn: null
      advertise_local_prefixes: false
