#!/bin/bash
# strongSwan updown script to fix XFRM policies with if_id marks
# This script is called by strongSwan when tunnels go up/down

# Get if_id from command line argument
IF_ID=$1

# strongSwan provides these environment variables:
# PLUTO_VERB: up-host, up-client, down-host, down-client
# PLUTO_MY_SOURCEIP: local inner IP
# PLUTO_PEER_SOURCEIP: remote inner IP
# PLUTO_MY_CLIENT: local subnet
# PLUTO_PEER_CLIENT: remote subnet

case "$PLUTO_VERB" in
    up-host|up-client)
        # Tunnel is up - add if_id to XFRM policies
        # strongSwan creates policies without if_id, we need to recreate them with if_id
        
        # Parse the subnets
        SRC_NET="$PLUTO_MY_CLIENT"
        DST_NET="$PLUTO_PEER_CLIENT"
        
        # Get the SA details to use in the policy template
        # We need the reqid from the existing policy
        REQID=$(ip xfrm policy | grep -A 5 "src $SRC_NET dst $DST_NET dir out" | grep "reqid" | head -1 | awk '{print $2}')
        
        if [ -n "$REQID" ]; then
            # Delete the old policy without if_id
            ip xfrm policy delete src "$SRC_NET" dst "$DST_NET" dir out 2>/dev/null
            
            # Add new policy with if_id
            ip xfrm policy add src "$SRC_NET" dst "$DST_NET" dir out \
                if_id "$IF_ID" tmpl src 0.0.0.0 dst 0.0.0.0 \
                proto esp reqid "$REQID" mode tunnel
            
            # Also fix the inbound policy
            ip xfrm policy delete src "$DST_NET" dst "$SRC_NET" dir in 2>/dev/null
            ip xfrm policy add src "$DST_NET" dst "$SRC_NET" dir in \
                if_id "$IF_ID" tmpl src 0.0.0.0 dst 0.0.0.0 \
                proto esp reqid "$REQID" mode tunnel
            
            # Fix the forward policy
            ip xfrm policy delete src "$DST_NET" dst "$SRC_NET" dir fwd 2>/dev/null
            ip xfrm policy add src "$DST_NET" dst "$SRC_NET" dir fwd \
                if_id "$IF_ID" tmpl src 0.0.0.0 dst 0.0.0.0 \
                proto esp reqid "$REQID" mode tunnel
            
            logger -t vpngw-updown "Added if_id $IF_ID to XFRM policies for $SRC_NET <-> $DST_NET"
        fi
        ;;
    down-host|down-client)
        # Tunnel is down - policies will be cleaned up by strongSwan
        ;;
esac

exit 0
